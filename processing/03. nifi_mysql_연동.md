## 3. nifi 와 mysql 연동 및 데이터 수집 파이프라인 구성
### 실행 순서
1. kubernetes 환경 구성 -> kubespray

2. helm으로 mysql 설치
```
   helm install mysql oci://registry-1.docker.io/bitnamicharts/mysql
```

3. mysql password 설정
```
   MYSQL_ROOT_PASSWORD=$(kubectl get secret --namespace default mysql -o jsonpath="{.data.mysql-root-password}" | base64 -d)
```

4. mysql client 접속
```
1. Run a pod that you can use as a client:

   kubectl run mysql-client --rm --tty -i --restart='Never' --image  docker.io/bitnami/mysql:8.0.34-debian-11-r8 --namespace default --env MYSQL_ROOT_PASSWORD=$MYSQL_ROOT_PASSWORD --command -- bash

2. To connect to primary service (read/write):

   mysql -h mysql.default.svc.cluster.local -uroot -p"$MYSQL_ROOT_PASSWORD"

3. 사용자 추가 및 권한 허용
   create user '유저id'@'%' identified by '유저pw';
   GRANT ALL PRIVILEGES ON 권한줄DB.* TO 유저id@'%';
   flush PRIVILEGES;
   # 권한 허용 확인
   SHOW GRANTS FOR 유저id@'%';
```
5. database & table 생성
```
  # database "trade" 생성
  mysql> create database trade;
   
  # 데이터베이스 목록 확인
  mysql> show databases;

  # 데이터베이스 선택
  mysql> use testDB;

  # 테이블 생성
  mysql> 
  CREATE TABLE nation_trade_list (
    balPayments DECIMAL(20, 0),   
    expCnt DECIMAL(20, 0),
    expDlr DECIMAL(20, 0),
    impCnt DECIMAL(20, 0),
    impDlr DECIMAL(20, 0),
    statCd VARCHAR(30),
    statCdCntnKor1 VARCHAR(255),
    year VARCHAR(10)
  );

  # 칼럼 정보
  balPayments    number
  무역수지(달러)  
  expCnt    number
  수출건수
  expDlr    number
  수출금액(달러)
  impCnt    number
  수입건수
  impDlr    number
  수입금액(달러)
  statCd    string
  국가코드
```
* table columns 및 options 확인
```
  mysql> desc nation_trade_list;
```
<img width="577" alt="image" src="https://github.com/igikorea-chaeyeon-jung/sandox/assets/133837435/2b20d47d-0196-4e55-bda7-452008ae5325">


6. wget 설치 및 mysql connector설치
```
   sudo yum install wget
   wget https://dev.mysql.com/get/Downloads/Connector-J/mysql-connector-java-8.0.27.tar.gz
   tar -zxvf mysql-connector-java-8.0.27.tar.gz
```

7. mysql pod 내 /opt/nifi/nifi-current/ 경로로 mysql-connector-java-8.0.27.tar.gz 파일 복사붙여넣기
```
   kubectl cp /home/centos/mysql-connector-java-8.0.27/mysql-connector-java-8.0.27.jar nifi-0:/opt/nifi/nifi-current/
   # pod 접속
   kubectl exec -it nifi-0 -- /bin/bash
   # pod 나가기
   exit
```  

* 이외 명령어
```
  # database 삭제
  mysql> DROP DATABASE testDB;
```
8.d
하위 그림 참고
```
# Database Connection URL 속성에 다음 내용 추가
   jdbc:mysql://mysql.default.svc.cluster.local:3306/{DB명}
# Database Driver Class Name에 다음 내용 추가
   com.mysql.jdbc.Driver
# Database Driver Location에 다음 내용 추가
   /opt/nifi/nifi-current/mysql-connector-java-8.0.27.jar
# Database Uer
   유저아이디 입력
# Password
   유저비밀번호 입력
```


  mysql 테이블 구성
<img width="901" alt="스크린샷 2023-08-11 오후 5 16 17" src="https://github.com/igikorea-chaeyeon-jung/sandox/assets/133837435/9e26a5f3-0a68-4204-8b28-a27a6698acde">

  Configure Processor(PutSQL)
<img width="793" alt="스크린샷 2023-08-11 오후 5 24 28" src="https://github.com/igikorea-chaeyeon-jung/sandox/assets/133837435/defe016f-081f-41c8-8cdc-2d9a1953a831">

  Controller Service Details
<img width="1209" alt="스크린샷 2023-08-11 오후 5 24 44" src="https://github.com/igikorea-chaeyeon-jung/sandox/assets/133837435/5fd23d1e-d614-4a16-9c6a-e6244be72598">
