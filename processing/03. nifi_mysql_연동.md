## 3. nifi 와 mysql 연동 및 데이터 수집 파이프라인 구성
###  ▶️  실행 순서
1. kubernetes 환경 구성 -> kubespray
<br/>

2. helm으로 mysql 설치
```
   helm install mysql oci://registry-1.docker.io/bitnamicharts/mysql
```
<br/> 

3. mysql password 설정
```
   MYSQL_ROOT_PASSWORD=$(kubectl get secret --namespace default mysql -o jsonpath="{.data.mysql-root-password}" | base64 -d)
```
<br/> 

4. mysql client 접속
```
# 1. Run a pod that you can use as a client:

   kubectl run mysql-client --rm --tty -i --restart='Never' --image  docker.io/bitnami/mysql:8.0.34-debian-11-r8 --namespace default --env MYSQL_ROOT_PASSWORD=$MYSQL_ROOT_PASSWORD --command -- bash

# 2. To connect to primary service (read/write):

   mysql -h mysql.default.svc.cluster.local -uroot -p"$MYSQL_ROOT_PASSWORD"

# 3. 사용자 추가 및 권한 허용
   create user '유저id'@'%' identified by '유저pw';
   GRANT ALL PRIVILEGES ON 권한줄DB.* TO 유저id@'%';
   flush PRIVILEGES;
   # 권한 허용 확인
   SHOW GRANTS FOR 유저id@'%';
```
<br/> 

5. database & table 생성
```
  # database "trade" 생성
  mysql> create database trade;
   
  # 데이터베이스 목록 확인
  mysql> show databases;

  # 데이터베이스 선택
  mysql> use testDB;

  # 테이블 생성
  mysql> 
  CREATE TABLE nation_trade_list (
    balPayments DECIMAL(20, 0),   
    expCnt DECIMAL(20, 0),
    expDlr DECIMAL(20, 0),
    impCnt DECIMAL(20, 0),
    impDlr DECIMAL(20, 0),
    statCd VARCHAR(30),
    statCdCntnKor1 VARCHAR(255),
    year VARCHAR(10)
  );

  # 칼럼 정보
     balPayments    number
     무역수지(달러)  
     expCnt    number
     수출건수
     expDlr    number
     수출금액(달러)
     impCnt    number
     수입건수
     impDlr    number
     수입금액(달러)
     statCd    string
     국가코드
```
* table columns 및 options 확인
```
  mysql> desc nation_trade_list;
```
<img width="577" alt="image" src="https://github.com/igikorea-chaeyeon-jung/sandox/assets/133837435/2b20d47d-0196-4e55-bda7-452008ae5325">
<br/> 
<br/> 

6. wget 설치 및 mysql connector설치
```
   sudo yum install wget
   wget https://dev.mysql.com/get/Downloads/Connector-J/mysql-connector-java-8.0.27.tar.gz
   tar -zxvf mysql-connector-java-8.0.27.tar
```
<br/> 

7. mysql pod 내 /opt/nifi/nifi-current/ 경로로 mysql-connector-java-8.0.27.tar.gz 파일 복사붙여넣기
```
   kubectl cp /home/centos/mysql-connector-java-8.0.27/mysql-connector-java-8.0.27.jar nifi-0:/opt/nifi/nifi-current/
   # pod 접속
   kubectl exec -it nifi-0 -- /bin/bash
   # pod 나가기
   exit
```
<br/> 

## nifi
### 파이프라인 설계
⭕️ 프로세서 연결 순서

   GetSFTP ▶️ SplitJson ▶️ AttributesToJSON ▶️ ConvertJSONToSQL ▶️ PutSQL

GetSFTP


SplitJson
<img width="1367" alt="스크린샷 2023-08-16 오후 5 50 06" src="https://github.com/igikorea-chaeyeon-jung/sandox/assets/133837435/c01b29a6-7c4d-4fd5-8a29-ee72d07aca9f">

   JsonPath Expression : json 트리구조에서 요소들을 가져올 배열명 지정
   Null Value Representation: empty string

AttributesToJSON
<img width="1367" alt="스크린샷 2023-08-16 오후 5 50 14" src="https://github.com/igikorea-chaeyeon-jung/sandox/assets/133837435/a05deaab-a3fa-4716-aa62-9644e9a2aceb">

   Destination: flowfile-attribute
   Return Type: json
   Path Not Found Behavior: ignore
   Null Value Representation: empty string

   여기까지 설정해주었다면, key와 value이 될 값들을 추가해준다.(🔼사진참고)
   
   
ConvertJSONToSQL
<img width="1367" alt="스크린샷 2023-08-16 오후 5 50 24" src="https://github.com/igikorea-chaeyeon-jung/sandox/assets/133837435/8639214e-1259-42a9-b917-99d5d0fa938e">
 JDBC Connection Pool : DBCPConnectionPool 추가 버튼 클릭 시 DBCPConnectionPool에 대한 세부사항 설청 창이 뜸. 
  <img width="1434" alt="스크린샷 2023-08-11 오후 4 56 05" src="https://github.com/igikorea-chaeyeon-jung/sandox/assets/133837435/2dff6eca-fa85-45bd-9ee8-2ada347d0539">
  하위내용 참고하여 설정
   - Database Connection URL:          
       jdbc:mysql://mysql.default.svc.cluster.local:3306/{DB명}
      
   - Database Driver Class Name: com.mysql.jdbc.Driver
      
   - Database Driver Location: /opt/nifi/nifi-current/mysql-connector-java-8.0.27.jar
   
   - Database Uer: 유저아이디 입력
     
   - Password: 유저비밀번호 입력
     
   여기까지 설정해주었다면 다시 ConvertJsonToSQL 프로세서로 돌아와서
   SQL문 insert를 위한 프로퍼티 설정 마저 진행.
   
   Statement Type: INSERT
   Table Name: nation_trade_list
   
PutSQL
<img width="1367" alt="스크린샷 2023-08-16 오후 5 50 32" src="https://github.com/igikorea-chaeyeon-jung/sandox/assets/133837435/cc411625-57b1-462f-8861-cd90d0133634">
PutSQL 프로세서에서는 JDBC Connection Pool만 설정하면 됨
   - JDBC Connection Pool: DBCPConnectionPool

* 이외 명령어
```
  # database 삭제
  mysql> DROP DATABASE testDB;
```
