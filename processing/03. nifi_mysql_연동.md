## 3. nifi ì™€ mysql ì—°ë™ ë° ë°ì´í„° ìˆ˜ì§‘ íŒŒì´í”„ë¼ì¸ êµ¬ì„±
###  â–¶ï¸  ì‹¤í–‰ ìˆœì„œ
1. kubernetes í™˜ê²½ êµ¬ì„± -> kubespray
<br/>

2. helmìœ¼ë¡œ mysql ì„¤ì¹˜
```
   helm install mysql oci://registry-1.docker.io/bitnamicharts/mysql
```
<br/> 

3. mysql password ì„¤ì •
```
   MYSQL_ROOT_PASSWORD=$(kubectl get secret --namespace default mysql -o jsonpath="{.data.mysql-root-password}" | base64 -d)
```
<br/> 

4. mysql client ì ‘ì†
```
# 1. Run a pod that you can use as a client:

   kubectl run mysql-client --rm --tty -i --restart='Never' --image  docker.io/bitnami/mysql:8.0.34-debian-11-r8 --namespace default --env MYSQL_ROOT_PASSWORD=$MYSQL_ROOT_PASSWORD --command -- bash

# 2. To connect to primary service (read/write):

   mysql -h mysql.default.svc.cluster.local -uroot -p"$MYSQL_ROOT_PASSWORD"

# 3. ì‚¬ìš©ì ì¶”ê°€ ë° ê¶Œí•œ í—ˆìš©
   create user 'ìœ ì €id'@'%' identified by 'ìœ ì €pw';
   GRANT ALL PRIVILEGES ON ê¶Œí•œì¤„DB.* TO ìœ ì €id@'%';
   flush PRIVILEGES;
   # ê¶Œí•œ í—ˆìš© í™•ì¸
   SHOW GRANTS FOR ìœ ì €id@'%';
```
<br/> 

5. database & table ìƒì„±
```
  # database "trade" ìƒì„±
  mysql> create database trade;
   
  # ë°ì´í„°ë² ì´ìŠ¤ ëª©ë¡ í™•ì¸
  mysql> show databases;

  # ë°ì´í„°ë² ì´ìŠ¤ ì„ íƒ
  mysql> use testDB;

  # í…Œì´ë¸” ìƒì„±
  mysql> 
  CREATE TABLE nation_trade_list (
    balPayments DECIMAL(20, 0),   
    expCnt DECIMAL(20, 0),
    expDlr DECIMAL(20, 0),
    impCnt DECIMAL(20, 0),
    impDlr DECIMAL(20, 0),
    statCd VARCHAR(30),
    statCdCntnKor1 VARCHAR(255),
    year VARCHAR(10)
  );

  # ì¹¼ëŸ¼ ì •ë³´
     balPayments Â  Â number
     ë¬´ì—­ìˆ˜ì§€(ë‹¬ëŸ¬)  
     expCnt Â  Â number
     ìˆ˜ì¶œê±´ìˆ˜
     expDlr Â  Â number
     ìˆ˜ì¶œê¸ˆì•¡(ë‹¬ëŸ¬)
     impCnt Â  Â number
     ìˆ˜ì…ê±´ìˆ˜
     impDlr Â  Â number
     ìˆ˜ì…ê¸ˆì•¡(ë‹¬ëŸ¬)
     statCd Â  Â string
     êµ­ê°€ì½”ë“œ
```
* table columns ë° options í™•ì¸
```
  mysql> desc nation_trade_list;
```
<img width="577" alt="image" src="https://github.com/igikorea-chaeyeon-jung/sandox/assets/133837435/2b20d47d-0196-4e55-bda7-452008ae5325">
<br/> 
<br/> 

6. wget ì„¤ì¹˜ ë° mysql connectorì„¤ì¹˜
```
   sudo yum install wget
   wget https://dev.mysql.com/get/Downloads/Connector-J/mysql-connector-java-8.0.27.tar.gz
   tar -zxvf mysql-connector-java-8.0.27.tar
```
<br/> 

7. mysql pod ë‚´ /opt/nifi/nifi-current/ ê²½ë¡œë¡œ mysql-connector-java-8.0.27.tar.gz íŒŒì¼ ë³µì‚¬ë¶™ì—¬ë„£ê¸°
```
   kubectl cp /home/centos/mysql-connector-java-8.0.27/mysql-connector-java-8.0.27.jar nifi-0:/opt/nifi/nifi-current/
   # pod ì ‘ì†
   kubectl exec -it nifi-0 -- /bin/bash
   # pod ë‚˜ê°€ê¸°
   exit
```
<br/> 

## nifi
### íŒŒì´í”„ë¼ì¸ ì„¤ê³„
â­•ï¸ í”„ë¡œì„¸ì„œ ì—°ê²° ìˆœì„œ

   GetSFTP â–¶ï¸ SplitJson â–¶ï¸ AttributesToJSON â–¶ï¸ ConvertJSONToSQL â–¶ï¸ PutSQL

GetSFTP


SplitJson
<img width="1367" alt="á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2023-08-16 á„‹á…©á„’á…® 5 50 06" src="https://github.com/igikorea-chaeyeon-jung/sandox/assets/133837435/c01b29a6-7c4d-4fd5-8a29-ee72d07aca9f">

   JsonPath Expression : json íŠ¸ë¦¬êµ¬ì¡°ì—ì„œ ìš”ì†Œë“¤ì„ ê°€ì ¸ì˜¬ ë°°ì—´ëª… ì§€ì •
   Null Value Representation: empty string

AttributesToJSON
<img width="1367" alt="á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2023-08-16 á„‹á…©á„’á…® 5 50 14" src="https://github.com/igikorea-chaeyeon-jung/sandox/assets/133837435/a05deaab-a3fa-4716-aa62-9644e9a2aceb">

   Destination: flowfile-attribute
   Return Type: json
   Path Not Found Behavior: ignore
   Null Value Representation: empty string

   ì—¬ê¸°ê¹Œì§€ ì„¤ì •í•´ì£¼ì—ˆë‹¤ë©´, keyì™€ valueì´ ë  ê°’ë“¤ì„ ì¶”ê°€í•´ì¤€ë‹¤.(ğŸ”¼ì‚¬ì§„ì°¸ê³ )
   
   
ConvertJSONToSQL
<img width="1367" alt="á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2023-08-16 á„‹á…©á„’á…® 5 50 24" src="https://github.com/igikorea-chaeyeon-jung/sandox/assets/133837435/8639214e-1259-42a9-b917-99d5d0fa938e">
 JDBC Connection Pool : DBCPConnectionPool ì¶”ê°€ ë²„íŠ¼ í´ë¦­ ì‹œ DBCPConnectionPoolì— ëŒ€í•œ ì„¸ë¶€ì‚¬í•­ ì„¤ì²­ ì°½ì´ ëœ¸. 
  <img width="1434" alt="á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2023-08-11 á„‹á…©á„’á…® 4 56 05" src="https://github.com/igikorea-chaeyeon-jung/sandox/assets/133837435/2dff6eca-fa85-45bd-9ee8-2ada347d0539">
  í•˜ìœ„ë‚´ìš© ì°¸ê³ í•˜ì—¬ ì„¤ì •
   - Database Connection URL:          
       jdbc:mysql://mysql.default.svc.cluster.local:3306/{DBëª…}
      
   - Database Driver Class Name: com.mysql.jdbc.Driver
      
   - Database Driver Location: /opt/nifi/nifi-current/mysql-connector-java-8.0.27.jar
   
   - Database Uer: ìœ ì €ì•„ì´ë”” ì…ë ¥
     
   - Password: ìœ ì €ë¹„ë°€ë²ˆí˜¸ ì…ë ¥
     
   ì—¬ê¸°ê¹Œì§€ ì„¤ì •í•´ì£¼ì—ˆë‹¤ë©´ ë‹¤ì‹œ ConvertJsonToSQL í”„ë¡œì„¸ì„œë¡œ ëŒì•„ì™€ì„œ
   SQLë¬¸ insertë¥¼ ìœ„í•œ í”„ë¡œí¼í‹° ì„¤ì • ë§ˆì € ì§„í–‰.
   
   Statement Type: INSERT
   Table Name: nation_trade_list
   
PutSQL
<img width="1367" alt="á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2023-08-16 á„‹á…©á„’á…® 5 50 32" src="https://github.com/igikorea-chaeyeon-jung/sandox/assets/133837435/cc411625-57b1-462f-8861-cd90d0133634">
PutSQL í”„ë¡œì„¸ì„œì—ì„œëŠ” JDBC Connection Poolë§Œ ì„¤ì •í•˜ë©´ ë¨
   - JDBC Connection Pool: DBCPConnectionPool

* ì´ì™¸ ëª…ë ¹ì–´
```
  # database ì‚­ì œ
  mysql> DROP DATABASE testDB;
```
