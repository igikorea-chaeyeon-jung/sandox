# nifi 설치 - cetic/nifi
# 참고 : https://github.com/cetic/helm-nifi/blob/master/doc/INSTALLATION.md

# wget 설치
sudo yum install wget

# helm 설치
wget https://get.helm.sh/helm-v3.12.1-linux-amd64.tar.gz

#
sudo mv linux-amd64/helm /usr/local/bin/.

# nc 설치
yum install nc

# 압축해제
tar xvfz helm-v3.12.1-linux-amd64.tar.gz

#버전확인
helm version

# 특정 네임스페이스의 pod 리스트업
kubectl -n local-path-storage get pod

# pod 디테일 정보확인
kubectl -n local-path-storage describe pod local-path-provisioner-6464fcbd8b-nzzgm

# 에러 발생
# Container runtime network not ready: NetworkReady=false reason:NetworkPluginNotReady 
# message:docker: network plugin is not ready: cni config uninitialized
# 칼리코(Container Network Interface 구현체) 설치
kubectl create -f https://raw.githubusercontent.com/projectcalico/calico/v3.25.0/manifests/tigera-operator.yaml

# 로그확인
journalctl -f -u kubelet | egrep "kubelet.go|cni.go"

# 1. 레포 클론
git clone https://github.com/cetic/helm-nifi.git
cd helm-nifi
helm repo add bitnami https://charts.bitnami.com/bitnami
helm repo add dysnix https://dysnix.github.io/charts/
helm repo update
helm dep up

# 2. nifi 설치
helm install nifi .

# 2번까지 진행하고나서 kubectl get pods 해보면 
# nifi 1개와 3개의 zookeeper pod가 리스트업되는데 status가 pending 상태

# 예시)
#     nifi-0             pending
#     zookeeper-0       pending
#     zookeeper-1       pending
#     zookeeper-2       pending

# nifi 1개의 pending은 kubectl describe pod nifi-0 했을 때 taint되어있다는 에러메세지 발견
# kubectl describe node <노드명> -> taint 속성이 설정되어있는 것 확인
# kubectl taint nodes --all node.kubernetes.io/not-ready- 명령어로 taint 해제했을 때 Pending에서 Running상태로 변경
 
# 그런데 아직 zookeeper3개 파드는 여전히 Pending상태..
# kubectl describe pod zookeeper-0 -> 1 pod has unbound immediate PersistentVolumeClaims helm 에러메세지
# cetic/nifi 문서에 prerequisites으로 "Persistent Volumes (PV) provisioner support in the underlying infrastructure." 요구하고있음

# 현재상황
# 1. storagevalue.yaml 파일에서 value.yaml 파일 값을 참조하는 부분있어서 values 설정파일 수정 
; persistence:
;  enabled: false  -> true -> pvc 사용하겠다
;  accessModes:  [ReadWriteOnce]

# 결론
; 프로젝트 실행전 스토리지 프로비저너 설치하면 돌아갈 것같은데 프로비저너 설치과정이 이해안되서 홀딩+공부중..


# 3. Access nifi
kubectl port-forward service/nifi 8443:8443


